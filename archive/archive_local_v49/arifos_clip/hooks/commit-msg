#!/bin/sh
# Commit-msg hook: ensure commit message and session state indicate a sealed session.

MSG_FILE="$1"

# Must have a session file
if [ ! -f ".arifos_clip/session.json" ]; then
    echo "Commit blocked: A CLIP session file not found."
    exit 1
fi

status=$(grep -o '"status": "[^"]*' .arifos_clip/session.json | cut -d'"' -f4)
if [ "$status" != "SEALED" ]; then
    echo "Commit blocked: session not sealed by A CLIP."
    echo "Hint: seal with an authority token (HMAC) minted via:"
    echo "  python -c \"from arifos_clip.aclip.bridge.authority import create_token; print(create_token('<SESSION_ID>'))\""
    echo "Then rerun: 999 seal --apply --authority-token <TOKEN>"
    exit 1
fi

# Commit message must mention "SEALED"
if ! grep -q "SEALED" "$MSG_FILE"; then
    echo "Commit message must include 'SEALED'."
    exit 1
fi

exit 0
