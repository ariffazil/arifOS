# VAULT-999 Database Infrastructure (v47.1)
# Quantum-Geometric Memory: Postgres (CCC/BBB) + Redis (Cache) + Qdrant (Vectors)
# Authority: Δ Antigravity (Architect) + Ω Claude (Engineer)
# Status: PRODUCTION

services:
  # Postgres: CCC Constitutional Ledger + BBB Machine Memory
  postgres:
    image: postgres:16-alpine
    container_name: arifos-vault-postgres
    environment:
      POSTGRES_DB: arifos_vault999
      POSTGRES_USER: arifos
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-arifos_dev_password}
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --locale=C"
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./arifos_core/memory/ledger/schema.sql:/docker-entrypoint-initdb.d/01-schema.sql:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U arifos -d arifos_vault999"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - vault999_network
    restart: unless-stopped

  # Redis: CCC Floor Cache + BBB Session Cache
  redis:
    image: redis:7-alpine
    container_name: arifos-vault-redis
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
    networks:
      - vault999_network
    restart: unless-stopped

  # Qdrant: BBB Semantic Vector Store (Orthogonal Memory)
  qdrant:
    image: qdrant/qdrant:v1.7.4
    container_name: arifos-vault-qdrant
    ports:
      - "6333:6333" # HTTP API
      - "6334:6334" # gRPC API
    volumes:
      - qdrant_data:/qdrant/storage
    environment:
      QDRANT__SERVICE__HTTP_PORT: 6333
      QDRANT__SERVICE__GRPC_PORT: 6334
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--no-verbose",
          "--tries=1",
          "--spider",
          "http://localhost:6333/health",
        ]
      interval: 15s
      timeout: 5s
      retries: 3
    networks:
      - vault999_network
    restart: unless-stopped

  # pgAdmin (Optional - for development/debugging)
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: arifos-vault-pgadmin
    environment:
      PGADMIN_DEFAULT_EMAIL: ${PGADMIN_EMAIL:-admin@arifos.local}
      PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_PASSWORD:-admin}
      PGADMIN_CONFIG_SERVER_MODE: "False"
    ports:
      - "5050:80"
    volumes:
      - pgadmin_data:/var/lib/pgadmin
    depends_on:
      - postgres
    networks:
      - vault999_network
    restart: unless-stopped
    profiles:
      - dev # Only start with: docker-compose --profile dev up

networks:
  vault999_network:
    driver: bridge
    name: arifos_vault999_net

volumes:
  postgres_data:
    name: arifos_vault_postgres_data
  redis_data:
    name: arifos_vault_redis_data
  qdrant_data:
    name: arifos_vault_qdrant_data
  pgadmin_data:
    name: arifos_vault_pgadmin_data

# Usage:
# docker-compose up -d                 # Start Postgres + Redis + Qdrant
# docker-compose --profile dev up -d   # Start with pgAdmin included
# docker-compose down                  # Stop services
# docker-compose down -v               # Stop and remove volumes (DESTRUCTIVE)
