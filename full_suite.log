============================= test session starts =============================
platform win32 -- Python 3.14.0, pytest-8.4.2, pluggy-1.6.0
rootdir: C:\Users\User\OneDrive\Documents\GitHub\arifOS
configfile: pyproject.toml
testpaths: tests
plugins: anyio-4.11.0, cov-7.0.0
collected 2266 items

tests\evidence\test_atomic_ingestion.py ....                             [  0%]
tests\evidence\test_conflict_routing.py ....                             [  0%]
tests\evidence\test_evidence_pack.py ...                                 [  0%]
tests\governance\test_merkle_ledger.py ....                              [  0%]
tests\governance\test_proof_of_governance.py ....                        [  0%]
tests\governance\test_signatures.py ...                                  [  0%]
tests\integration\test_memory_band_routing_v38.py ..s.......s........... [  1%]
.....s.s.....sss                                                         [  2%]
tests\integration\test_memory_eureka_comprehensive_v38.py .............. [  3%]
...........                                                              [  3%]
tests\integration\test_memory_floor_integration.py ..................... [  4%]
...............                                                          [  5%]
tests\integration\test_memory_integration_v38_eureka.py ................ [  6%]
......................                                                   [  7%]
tests\integration\test_memory_policy_spec_alignment.py ............s..s. [  7%]
...............                                                          [  8%]
tests\integration\test_pipeline_with_memory.py ...........               [  8%]
tests\judiciary\test_firewall.py ...                                     [  9%]
tests\judiciary\test_witness_council.py ....                             [  9%]
tests\temporal\test_freshness.py ...                                     [  9%]
tests\temporal\test_phoenix_hold.py ......                               [  9%]
tests\test_aclip_bridge.py ...............                               [ 10%]
tests\test_aclip_v41_2_adversarial.py ....................               [ 11%]
tests\test_amanah_detector.py .......................................... [ 13%]
...............................                                          [ 14%]
tests\test_anti_hantu_f9.py ....                                         [ 14%]
tests\test_antihantu_unit.py ...                                         [ 14%]
tests\test_apex_and_ledger_edges.py sss                                  [ 14%]
tests\test_apex_genius_verdicts.py ....................................  [ 16%]
tests\test_apex_measurements_eval.py ................................... [ 17%]
..........                                                               [ 18%]
tests\test_apex_prime_floors.py ............................             [ 19%]
tests\test_apex_prime_floors_mocked.py ............s....                 [ 20%]
tests\test_apex_prime_output_v41.py ........                             [ 20%]
tests\test_apex_review.py ...                                            [ 20%]
tests\test_api_contract.py ............................................. [ 22%]
......                                                                   [ 23%]
tests\test_caged_llm_harness.py ...........................              [ 24%]
tests\test_canon_drift_guard.py ...............................          [ 25%]
tests\test_codex_ledger.py ..                                            [ 25%]
tests\test_cooling_ledger.py .                                           [ 25%]
tests\test_cooling_ledger_integrity.py ...............                   [ 26%]
tests\test_cooling_ledger_integrity_mocked.py ...........                [ 26%]
tests\test_cooling_ledger_kms_integration.py ...                         [ 27%]
tests\test_cooling_ledger_schema_compliance.py ...                       [ 27%]
tests\test_cooling_phoenix_v38_alignment.py ............................ [ 28%]
.............                                                            [ 29%]
tests\test_dream_forge.py ....................................           [ 30%]
tests\test_engines_arif_adam.py ................................         [ 32%]
tests\test_epoch_comparison.py ..................................        [ 33%]
tests\test_eye_sentinel.py ...............................               [ 34%]
tests\test_fag.py ............                                           [ 35%]
tests\test_fag_hardening.py ....................                         [ 36%]
tests\test_fag_statistics_audit.py ............                          [ 36%]
tests\test_fag_write.py ...........                                      [ 37%]
tests\test_federation_router.py ..................................       [ 38%]
tests\test_floors_v38_alignment.py .........................             [ 39%]
tests\test_genius_law_v38_alignment.py ...........................       [ 41%]
tests\test_genius_metrics.py ........................................... [ 43%]
.........................                                                [ 44%]
tests\test_governance_regression.py ........................             [ 45%]
tests\test_governed_llm.py ...                                           [ 45%]
tests\test_governed_session_wrapper.py ...                               [ 45%]
tests\test_grey_zone.py ........................                         [ 46%]
tests\test_guard_v35.py ............                                     [ 47%]
tests\test_ignition_profiles.py ...                                      [ 47%]
tests\test_integration_common_utils.py ..........                        [ 47%]
tests\test_kms_signer.py .                                               [ 47%]
tests\test_ledger_cryptography.py .....................                  [ 48%]
tests\test_ledger_sanity.py ..........                                   [ 49%]
tests\test_llm_adapters.py .....................                         [ 49%]
tests\test_mcp_fag_integration.py ...........                            [ 50%]
tests\test_mcp_honesty_v41.py ......                                     [ 50%]
tests\test_mcp_v0_strict.py ...............                              [ 51%]
tests\test_memory_enforcement_v37.py ................                    [ 52%]
tests\test_memory_phase1_invariants.py ........                          [ 52%]
tests\test_memory_phase1_routing.py ..........                           [ 52%]
tests\test_memory_phase2_integration.py ..                               [ 52%]
tests\test_memory_policy_v38.py ........................................ [ 54%]
...................................                                      [ 56%]
tests\test_memory_stack_v37.py .........................                 [ 57%]
tests\test_phoenix72.py .                                                [ 57%]
tests\test_phoenix_72_entropy_rot.py .....................               [ 58%]
tests\test_pipeline_order_v36.py .                                       [ 58%]
tests\test_pipeline_routing.py ..................                        [ 59%]
tests\test_pipeline_stages_444_555_666.py ......                         [ 59%]
tests\test_pipeline_v38_alignment.py ................................... [ 60%]
.                                                                        [ 61%]
tests\test_pipeline_waw_integration.py ...................               [ 61%]
tests\test_runtime_manifest.py ......................................... [ 63%]
....................                                                     [ 64%]
tests\test_sabar_partial_separation.py ........                          [ 64%]
tests\test_seal_proposed_canon_v36.py .....                              [ 65%]
tests\test_session_dependency_guard.py ....                              [ 65%]
tests\test_session_physics.py F..F                                       [ 65%]
tests\test_sovereignty_all_providers.py ................................ [ 66%]
...........                                                              [ 67%]
tests\test_tearframe_integration.py .FF                                  [ 67%]
tests\test_telemetry_v36_spec_alignment.py ............................. [ 68%]
....................                                                     [ 69%]
tests\test_time_immutability.py .......                                  [ 69%]
tests\test_trinity.py ..........s                                        [ 70%]
tests\test_v35_features.py ..........................                    [ 71%]
tests\test_v38_runtime_upgrade.py ........................               [ 72%]
tests\test_v39_ci_guardrails.py .............                            [ 73%]
tests\test_vault_retrieval_v36.py .....................                  [ 74%]
tests\test_vector_adapter.py ..                                          [ 74%]
tests\test_void_stress.py .............................................. [ 76%]
...........................................................              [ 78%]
tests\test_waw_apex_escalation.py ........                               [ 79%]
tests\test_waw_geox_signals.py ......................................... [ 81%]
                                                                         [ 81%]
tests\test_waw_organs.py ............................................... [ 83%]
.......                                                                  [ 83%]
tests\test_waw_prompt_signals.py .............................           [ 84%]
tests\test_waw_prompt_v38_alignment.py ................................. [ 86%]
..................                                                       [ 86%]
tests\test_waw_rif_signals.py .........................................  [ 88%]
tests\test_waw_wealth_signals.py ................................        [ 90%]
tests\test_waw_well_signals.py ......................................... [ 92%]
.........                                                                [ 92%]
tests\unit\test_api_app.py ...................................           [ 93%]
tests\unit\test_l7_memory.py ........................................... [ 95%]
...........................                                              [ 97%]
tests\unit\test_mcp_server.py ....................................       [ 98%]
tests\unit\test_memory_band_router_unit.py ............................. [ 99%]
..                                                                       [100%]

================================== FAILURES ===================================
________________ TestSessionPhysics.test_burst_triggers_sabar _________________

self = <tests.test_session_physics.TestSessionPhysics testMethod=test_burst_triggers_sabar>

    def test_burst_triggers_sabar(self):
        """Simulate rapid sequence of turns with high turn_rate / low delta_t variance T SABAR."""
        tel = SessionTelemetry(max_session_tokens=100000)
    
        # Simulate 20 rapid turns
        for i in range(20):
            tel.start_turn(tokens_in=50, temperature=0.7, top_p=0.9)
            # Artificial sleep to create very small delta_t?
            # We can't sleep in unit test easily without mocking time
            # But Telemetry uses time.time().
            # We will manually inject snapshots to control time.
            pass
    
        # We'll construct snapshots manually to ensure precise timing
        snapshots = []
        base_time = 1000.0
    
        for i in range(20):
            t_start = base_time + (i * 0.1) # 100ms per turn (very fast)
            t_end = t_start + 0.01          # 10ms execution
    
            s = TelemetrySnapshot(
                t_start=t_start,
                t_end=t_end,
                delta_t=0.01, # Constant, low variance
                session_duration=2.0 + (i*0.1), # accumulating
                tokens_in=100,
                tokens_out=100,
                turn_count=i+1,
                verdict_counts={"SEAL": i+1},
                context_length_used=200,
                kv_cache_size=0,
                timeout=False,
                safety_block=False,
                truncation_flag=False,
                temperature=0.7,
                top_p=0.9,
                top_k=40,
                verdict="SEAL"
            )
            snapshots.append(s)
    
        attrs = compute_attributes(snapshots, 100000)
    
        # Check burst conditions
        # turn_rate: 20 turns in ~3 seconds = ~400 turns/min
        self.assertTrue(attrs.turn_rate > 30.0, f"Turn rate {attrs.turn_rate} should be > 30")
    
        # stability_var_dt: delta_t is always 0.01 -> variance 0.0
        self.assertTrue(attrs.stability_var_dt < 0.05, f"Variance {attrs.stability_var_dt} should be low")
    
        verdict = evaluate_physics_floors(attrs)
>       self.assertEqual(verdict, Verdict.SABAR, "Burst should trigger SABAR")
E       AssertionError: None != <Verdict.SABAR: 'SABAR'> : Burst should trigger SABAR

tests\test_session_physics.py:87: AssertionError
____________ TestSessionPhysics.test_void_streak_triggers_collapse ____________

self = <tests.test_session_physics.TestSessionPhysics testMethod=test_void_streak_triggers_collapse>

    def test_void_streak_triggers_collapse(self):
        """Feed a history with long void_streak T HOLD_888 or VOID."""
        tel = SessionTelemetry(max_session_tokens=1000)
    
        # 3 Consecutive VOIDs
        history = []
        for i in range(3):
            s = TelemetrySnapshot(
                t_start=0, t_end=1, delta_t=1, session_duration=10,
                tokens_in=10, tokens_out=10, turn_count=i+1,
                verdict_counts={}, context_length_used=0, kv_cache_size=0,
                timeout=False, safety_block=False, truncation_flag=False,
                temperature=0, top_p=0, top_k=0,
                verdict="VOID"
            )
            history.append(s)
    
        attrs = compute_attributes(history, 1000)
        self.assertEqual(attrs.void_streak, 3)
    
        verdict = evaluate_physics_floors(attrs)
        # Spec says: "If void_streak ... -> HOLD_888 (requires human ...) or force session reset."
        # Implementation has Verdict.HOLD_888
>       self.assertEqual(verdict, Verdict.HOLD_888)
E       AssertionError: None != <Verdict.HOLD_888: '888_HOLD'>

tests\test_session_physics.py:112: AssertionError
__________ TestTearframeIntegration.test_physics_veto_burst_override __________

self = <tests.test_tearframe_integration.TestTearframeIntegration testMethod=test_physics_veto_burst_override>

    def test_physics_veto_burst_override(self):
        """
        Test 1: "Physics Veto" hierarchy.
        Semantic Layer says SEAL. Physics says SABAR (Burst).
        Expectation: Verdict becomes SABAR.
        """
        # 1. Setup State with Semantic SEAL
        tel = SessionTelemetry()
        self._create_burst_history(tel, count=50) # Heavy burst
    
        state = PipelineState(
            query="Test burst query",
            job_id="test_job_burst",
            stakes_class=StakesClass.CLASS_B,
            # Semantic verdicts
            verdict=ApexVerdict(verdict=Verdict.SEAL, reason="Perfect answer", pulse=1.0),
            draft_response="This is a harmless response.",
            # Attach telemetry
            session_telemetry=tel
        )
    
        # 2. Run _finalize
        final_state = self.pipeline._finalize(state)
    
        # 3. Assertions
        # Should be SABAR
>       self.assertEqual(final_state.verdict.verdict, Verdict.SABAR)
E       AssertionError: <Verdict.SEAL: 'SEAL'> != <Verdict.SABAR: 'SABAR'>

tests\test_tearframe_integration.py:102: AssertionError
_________ TestTearframeIntegration.test_streak_accumulation_hold_888 __________

self = <tests.test_tearframe_integration.TestTearframeIntegration testMethod=test_streak_accumulation_hold_888>

    def test_streak_accumulation_hold_888(self):
        """
        Test 3: "Streak Accumulation & Escalation".
        Verify inputs with 'HOLD_888' contribute to streak.
        Scenario: 2 past HOLDs + 1 current SABAR -> Streak 3 -> HOLD_888.
        This proves HOLD counts towards streak AND physics overrides SEMANTIC SABAR with HOLD.
        """
        # 1. Setup Telemetry with previous HOLD_888 verdicts
        tel = SessionTelemetry()
    
        # Inject 2 turns of HOLD_888
        for i in range(2):
            snap = TelemetrySnapshot(
                t_start=time.time()-100, t_end=time.time()-99, delta_t=1, session_duration=10,
                tokens_in=10, tokens_out=10, turn_count=i+1,
                verdict_counts={}, context_length_used=0, kv_cache_size=0,
                timeout=False, safety_block=False, truncation_flag=False,
                temperature=0, top_p=0, top_k=0,
                verdict="HOLD_888" # Explicit HOLD string
            )
            tel.history.append(snap)
    
        tel.start_turn(tokens_in=10, temperature=0.7, top_p=1.0)
    
        state = PipelineState(
            query="Streak check",
            job_id="test_job_streak",
            stakes_class=StakesClass.CLASS_B,
            # Current turn is SABAR semantically (e.g. refused by 666)
            verdict=ApexVerdict(verdict=Verdict.SABAR, reason="Cannot answer this", pulse=0.5),
            session_telemetry=tel
        )
    
        # 2. Run _finalize
        # end_turn will append SABAR. History: [HOLD, HOLD, SABAR]. Streak = 3.
        # F7 should see Streak 3 -> Trigger HOLD_888 override.
        final_state = self.pipeline._finalize(state)
    
        # 3. Assertions
        # Should be HOLD_888 due to streak >= 3
>       self.assertEqual(final_state.verdict.verdict, Verdict.HOLD_888)
E       AssertionError: <Verdict.SABAR: 'SABAR'> != <Verdict.HOLD_888: '888_HOLD'>

tests\test_tearframe_integration.py:192: AssertionError
============================== warnings summary ===============================
arifos_core\evidence\evidence_pack.py:52
  C:\Users\User\OneDrive\Documents\GitHub\arifOS\arifos_core\evidence\evidence_pack.py:52: PydanticDeprecatedSince20: Pydantic V1 style `@validator` validators are deprecated. You should migrate to Pydantic V2 style `@field_validator` validators, see the migration guide for more details. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    @validator("query_hash")

arifos_core\evidence\evidence_pack.py:58
  C:\Users\User\OneDrive\Documents\GitHub\arifOS\arifos_core\evidence\evidence_pack.py:58: PydanticDeprecatedSince20: Pydantic V1 style `@validator` validators are deprecated. You should migrate to Pydantic V2 style `@field_validator` validators, see the migration guide for more details. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    @validator("hash_chain_provenance", each_item=True)

arifos_core\evidence\evidence_pack.py:64
  C:\Users\User\OneDrive\Documents\GitHub\arifOS\arifos_core\evidence\evidence_pack.py:64: PydanticDeprecatedSince20: Pydantic V1 style `@validator` validators are deprecated. You should migrate to Pydantic V2 style `@field_validator` validators, see the migration guide for more details. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    @validator("source_uris")

..\..\..\..\AppData\Local\Programs\Python\Python314\Lib\site-packages\litellm\litellm_core_utils\logging_utils.py:273: 17 warnings
  C:\Users\User\AppData\Local\Programs\Python\Python314\Lib\site-packages\litellm\litellm_core_utils\logging_utils.py:273: DeprecationWarning: 'asyncio.iscoroutinefunction' is deprecated and slated for removal in Python 3.16; use inspect.iscoroutinefunction() instead
    if asyncio.iscoroutinefunction(func):

tests/governance/test_proof_of_governance.py::test_no_semantic_leak_into_receipt
  C:\Users\User\OneDrive\Documents\GitHub\arifOS\tests\governance\test_proof_of_governance.py:152: PydanticDeprecatedSince20: The `dict` method is deprecated; use `model_dump` instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    data = json.dumps(receipt.dict()) # Pydantic dict

tests/test_fag.py::TestFAGLedgerIntegration::test_ledger_enabled_by_default
tests/test_mcp_fag_integration.py::TestMCPFAGTool::test_ledger_integration_via_mcp
  C:\Users\User\OneDrive\Documents\GitHub\arifOS\arifos_core\governance\ledger.py:26: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    "timestamp": datetime.datetime.utcnow().isoformat() + "Z",

tests/test_federation_router.py: 29 warnings
  C:\Users\User\OneDrive\Documents\GitHub\arifOS\arifos_core\connectors\federation_router.py:287: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    timestamp=datetime.utcnow().isoformat(),

tests/test_memory_stack_v37.py: 8 warnings
tests/test_pipeline_routing.py: 2 warnings
  C:\Users\User\AppData\Local\Programs\Python\Python314\Lib\site-packages\numpy\linalg\_linalg.py:2792: RuntimeWarning: overflow encountered in dot
    sqnorm = x.dot(x)

tests/unit/test_api_app.py::TestAppCreation::test_create_app_returns_fastapi_instance
  C:\Users\User\OneDrive\Documents\GitHub\arifOS\arifos_core\api\models_federation.py:29: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class FederationRouteRequest(BaseModel):

tests/unit/test_api_app.py::TestAppCreation::test_create_app_returns_fastapi_instance
  C:\Users\User\OneDrive\Documents\GitHub\arifOS\arifos_core\api\models_federation.py:89: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class FederationRouteResponse(BaseModel):

tests/unit/test_api_app.py::TestAppCreation::test_create_app_returns_fastapi_instance
  C:\Users\User\OneDrive\Documents\GitHub\arifOS\arifos_core\api\models_federation.py:161: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class FederationStatusResponse(BaseModel):

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ===========================
FAILED tests/test_session_physics.py::TestSessionPhysics::test_burst_triggers_sabar
FAILED tests/test_session_physics.py::TestSessionPhysics::test_void_streak_triggers_collapse
FAILED tests/test_tearframe_integration.py::TestTearframeIntegration::test_physics_veto_burst_override
FAILED tests/test_tearframe_integration.py::TestTearframeIntegration::test_streak_accumulation_hold_888
========== 4 failed, 2248 passed, 14 skipped, 65 warnings in 15.93s ===========
