name: Scheduled Ledger Audit

on:
  workflow_dispatch:
  schedule:
    - cron: '0 5 * * 0'  # weekly on Sunday 05:00 UTC

jobs:
  download-and-verify:
    runs-on: ubuntu-latest
    env:
      LEDGER_ARTIFACT_NAME: ledger-snapshot
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Download ledger snapshot artifact
        # This assumes a prior job in another workflow has uploaded artifact named 'ledger-snapshot'
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.LEDGER_ARTIFACT_NAME }}
          path: ./artifacts

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install deps (cryptography & boto3 if verifying)
        run: |
          python -m pip install --upgrade pip
          pip install -e .[dev] >/dev/null || true
          pip install boto3 cryptography || true

      - name: Run ledger verification (local verify if keys cached)
        id: verify
        run: |
          LEDGER_PATH="./artifacts/ledger.jsonl"
          if [ ! -f "$LEDGER_PATH" ]; then
            echo "No ledger artifact found at $LEDGER_PATH"
            exit 2
          fi
          # Enable local verification using cached keys in repo/artifacts/kms-keys (optionally)
          python scripts/verify_ledger_kms.py "$LEDGER_PATH" --local-verify --key-cache-dir ./artifacts/kms-keys || echo "VERIFY_RC=$?" > verify_result.txt

      - name: Create issue on failure
        if: failure() || steps.verify.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            let body = "Automated ledger verification failed in scheduled audit. Please investigate.\n\n";
            try {
              const stats = fs.readFileSync('verify_result.txt', 'utf8');
              body += "verify_result.txt:\n```\n" + stats + "\n```\n";
            } catch(e) {
              body += "No verify_result.txt available.\n";
            }
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: "[automated] ledger verification failed",
              body: body,
              labels: ["security","automated-audit"]
            });
            core.setOutput("issue-url", issue.data.html_url);
